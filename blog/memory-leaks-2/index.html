
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Memory leaks - Luc Dewavrin's weblog</title>
  <meta name="author" content="Luc Dewavrin">

  
  <meta name="description" content="Crazy Bob posted on ThreadLocal memory leaks.This type of memory leak really annoys me because I see it very often on Java EE servers and developers &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://lucdew.github.com/blog/memory-leaks-2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Luc Dewavrin's weblog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1239956-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Luc Dewavrin's weblog</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:lucdew.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Memory Leaks</h1>
    
    
      <p class="meta">
        








  


<time datetime="2006-02-28T00:00:00-05:00" pubdate data-updated="true">Feb 28<span>th</span>, 2006</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Crazy Bob posted on <a href='http://crazybob.org/2006/02/threadlocal-memory-leak.html'>ThreadLocal memory leaks</a>.This type of memory leak really annoys me because I see it very often on Java EE servers and developers are not aware of it.The error is mostly annoying in development, testing environmentswhere the Java EE server is not restarted and the applicationsare just redeployed. Therefore, threads (of thread pools) are not recreated and hold references to old application classes.</p>

<p>My advice is <strong>CLEAN YOUR THREADLOCALs</strong></p>

<p>Add a servlet filter, Web frameworkinterceptor or WS handler to set all ThreadLocal variables to null just beforereturning the response to the client. Lower level solutions should be preferred and turn out to be less risky. A dummy implementation (to give an idea) would be a servlet filter:</p>
<figure class='code'> <div class='highlight'><table><tr><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>ContextCleanerFilter</span> <span class='kd'>implements</span> <span class='n'>Filter</span> <span class='o'>{</span>
</span><span class='line'>
</span><span class='line'>	<span class='kd'>private</span> <span class='n'>ContextCleaner</span> <span class='n'>ctxCleaner</span><span class='o'>;</span>
</span><span class='line'>
</span><span class='line'>	<span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>init</span><span class='o'>(</span><span class='n'>FilterConfig</span> <span class='n'>filterConfig</span><span class='o'>)</span> <span class='o'>{</span>
</span><span class='line'>	    <span class='c1'>// CtxCleaner instantiated directly boooh !!!</span>
</span><span class='line'>		<span class='n'>ctxCleaner</span> <span class='o'>=</span> <span class='k'>new</span> <span class='n'>StaticContextCleaner</span><span class='o'>();</span>
</span><span class='line'>	 <span class='o'>}</span>
</span><span class='line'>
</span><span class='line'>	<span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>doFilter</span><span class='o'>(</span><span class='n'>ServletRequest</span> <span class='n'>request</span><span class='o'>,</span> <span class='n'>ServletResponse</span> <span class='n'>response</span><span class='o'>,</span> <span class='n'>FilterChain</span> <span class='n'>chain</span><span class='o'>)</span> <span class='kd'>throws</span> <span class='n'>IOException</span><span class='o'>,</span> <span class='n'>ServletException</span>  <span class='o'>{</span>
</span><span class='line'>
</span><span class='line'>	    <span class='c1'>// Reset ThreadLocals before processing the request</span>
</span><span class='line'>		<span class='k'>if</span> <span class='o'>(</span><span class='n'>ctxCleaner</span> <span class='o'>!=</span> <span class='kc'>null</span><span class='o'>)</span> <span class='n'>ctxCleaner</span><span class='o'>.</span><span class='na'>cleanAll</span><span class='o'>();</span>
</span><span class='line'>		<span class='n'>chain</span><span class='o'>.</span><span class='na'>doFilter</span><span class='o'>(</span><span class='n'>request</span><span class='o'>,</span><span class='n'>response</span><span class='o'>);</span>
</span><span class='line'>		<span class='c1'>// Reset ThreadLocals after processing the request</span>
</span><span class='line'>		<span class='k'>if</span> <span class='o'>(</span><span class='n'>ctxCleaner</span> <span class='o'>!=</span> <span class='kc'>null</span><span class='o'>)</span> <span class='n'>ctxCleaner</span><span class='o'>.</span><span class='na'>cleanAll</span><span class='o'>();</span>
</span><span class='line'>	<span class='o'>}</span>
</span><span class='line'>
</span><span class='line'>	<span class='kd'>public</span> <span class='kt'>void</span> <span class='nf'>destroy</span><span class='o'>()</span> <span class='o'>{</span>
</span><span class='line'>
</span><span class='line'>	<span class='o'>}</span>
</span><span class='line'>
</span><span class='line'><span class='o'>}</span>
</span></code></pre></td></tr></table></div></figure>
<p>with a ContextCleaner Interface:</p>
<figure class='code'> <div class='highlight'><table><tr><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class='kd'>public</span> <span class='kd'>interface</span> <span class='nc'>ContextCleaner</span> <span class='o'>{</span>
</span><span class='line'>   <span class='kt'>boolean</span> <span class='nf'>cleanAll</span><span class='o'>();</span>
</span><span class='line'><span class='o'>}</span>
</span></code></pre></td></tr></table></div></figure>
<p>and a dummy implementation:</p>
<figure class='code'> <div class='highlight'><table><tr><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>StaticContextCleaner</span> <span class='kd'>implements</span> <span class='n'>ContextCleaner</span> <span class='o'>{</span>
</span><span class='line'>
</span><span class='line'>	<span class='kd'>public</span> <span class='kt'>boolean</span> <span class='nf'>cleanAll</span><span class='o'>()</span> <span class='o'>{</span>
</span><span class='line'>	   <span class='n'>UserSession</span><span class='o'>.</span><span class='na'>setSessionData</span><span class='o'>(</span><span class='kc'>null</span><span class='o'>);</span>
</span><span class='line'>	   <span class='k'>return</span> <span class='kc'>true</span><span class='o'>;</span>
</span><span class='line'>	<span class='o'>}</span>
</span><span class='line'>
</span><span class='line'><span class='o'>}</span>
</span></code></pre></td></tr></table></div></figure>
<p>Where UserSession has static accessors to handle the ThreadLocal and is used by application code to store objects in a ThreadLocal instance:</p>
<figure class='code'> <div class='highlight'><table><tr><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>UserSession</span> <span class='o'>{</span>
</span><span class='line'>	<span class='kd'>private</span> <span class='kd'>static</span> <span class='n'>ThreadLocal</span> <span class='n'>m_session</span><span class='o'>=</span> <span class='k'>new</span> <span class='n'>ThreadLocal</span><span class='o'>();</span>
</span><span class='line'>	<span class='kd'>public</span> <span class='kd'>static</span> <span class='kt'>void</span> <span class='nf'>setSessionData</span><span class='o'>(</span><span class='n'>SessionData</span> <span class='n'>sessionData</span><span class='o'>){</span>
</span><span class='line'>		<span class='n'>m_session</span><span class='o'>.</span><span class='na'>set</span><span class='o'>(</span><span class='n'>sessionData</span><span class='o'>);</span>
</span><span class='line'>	<span class='o'>}</span>
</span><span class='line'>	<span class='kd'>public</span> <span class='kd'>static</span> <span class='n'>SessionData</span> <span class='nf'>getSessionData</span><span class='o'>(){</span>
</span><span class='line'>		<span class='k'>return</span> <span class='o'>(</span><span class='n'>SessionData</span><span class='o'>)</span><span class='n'>m_session</span><span class='o'>.</span><span class='na'>get</span><span class='o'>();</span>
</span><span class='line'>	<span class='o'>}</span>
</span><span class='line'><span class='o'>}</span>
</span></code></pre></td></tr></table></div></figure>
<p>The problem with this implementation is that it only works with classes that you controland are aware that they use ThreadLocal variables. Maybe with reflection it&#8217;s possible to accessthe current Thread&#8217;s Map which stores ThreadLocal objects and set them to null one by one. But it would be highly risky if your application server uses ThreadLocal for its own usage.</p>

<p>For further information on ThreadLocal memory leaks see <a href='http://blog.arendsen.net/?p=18'>this link</a></p></div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Luc Dewavrin</span></span>

      








  


<time datetime="2006-02-28T00:00:00-05:00" pubdate data-updated="true">Feb 28<span>th</span>, 2006</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/java/'>java</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://lucdew.github.com/blog/memory-leaks-2/" data-via="lucdew" data-counturl="http://lucdew.github.com/blog/memory-leaks-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/axis-through-apache-httpd-quick-tips-2/" title="Previous Post: Axis through Apache HTTPD quick tips">&laquo; Axis through Apache HTTPD quick tips</a>
      
      
        <a class="basic-alignment right" href="/blog/java-on-freebsd-2/" title="next Post: Java on FreeBSD">Java on FreeBSD &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/last-post/">Last Post</a>
      </li>
    
      <li class="post">
        <a href="/blog/osgi-survey/">OSGI survey</a>
      </li>
    
      <li class="post">
        <a href="/blog/mimic-facelet-layouts-in-grails/">Mimic facelet layouts in grails</a>
      </li>
    
      <li class="post">
        <a href="/blog/acquisition-de-sun-par-oracle/">Acquisition de Sun par Oracle</a>
      </li>
    
      <li class="post">
        <a href="/blog/seam-usage-in-production/">Seam usage in production</a>
      </li>
    
  </ul>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("lucdew", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/lucdew" class="twitter-follow-button" data-show-count="false">Follow @lucdew</a>
  
</section>




<section><h1>Tags</h1><p><a href="/tags/ant" title="Postings tagged ant" style="font-size: 11.0px; line-height:11.0px">ant</a> <a href="/tags/aop" title="Postings tagged aop" style="font-size: 11.0px; line-height:11.0px">aop</a> <a href="/tags/aspectj" title="Postings tagged aspectj" style="font-size: 11.0px; line-height:11.0px">aspectj</a> <a href="/tags/asterisk" title="Postings tagged asterisk" style="font-size: 10.5px; line-height:10.5px">asterisk</a> <a href="/tags/axis" title="Postings tagged axis" style="font-size: 10.5px; line-height:10.5px">axis</a> <a href="/tags/blog" title="Postings tagged blog" style="font-size: 10.5px; line-height:10.5px">blog</a> <a href="/tags/eclipse" title="Postings tagged eclipse" style="font-size: 11.0px; line-height:11.0px">eclipse</a> <a href="/tags/ejb" title="Postings tagged ejb" style="font-size: 10.5px; line-height:10.5px">ejb</a> <a href="/tags/firewall" title="Postings tagged firewall" style="font-size: 12.5px; line-height:12.5px">firewall</a> <a href="/tags/freebsd" title="Postings tagged freebsd" style="font-size: 10.5px; line-height:10.5px">freebsd</a> <a href="/tags/grails" title="Postings tagged grails" style="font-size: 10.5px; line-height:10.5px">grails</a> <a href="/tags/groovy" title="Postings tagged groovy" style="font-size: 10.5px; line-height:10.5px">groovy</a> <a href="/tags/gwt" title="Postings tagged gwt" style="font-size: 10.5px; line-height:10.5px">gwt</a> <a href="/tags/htmlunit" title="Postings tagged htmlunit" style="font-size: 10.5px; line-height:10.5px">htmlunit</a> <a href="/tags/jBPM" title="Postings tagged jBPM" style="font-size: 11.0px; line-height:11.0px">jBPM</a> <a href="/tags/java" title="Postings tagged java" style="font-size: 12.5px; line-height:12.5px">java</a> <a href="/tags/jaxb" title="Postings tagged jaxb" style="font-size: 10.5px; line-height:10.5px">jaxb</a> <a href="/tags/jdbc" title="Postings tagged jdbc" style="font-size: 11.0px; line-height:11.0px">jdbc</a> <a href="/tags/jibx" title="Postings tagged jibx" style="font-size: 10.5px; line-height:10.5px">jibx</a> <a href="/tags/jms" title="Postings tagged jms" style="font-size: 10.5px; line-height:10.5px">jms</a> <a href="/tags/jmx" title="Postings tagged jmx" style="font-size: 10.5px; line-height:10.5px">jmx</a> <a href="/tags/jpa" title="Postings tagged jpa" style="font-size: 10.5px; line-height:10.5px">jpa</a> <a href="/tags/jrockit" title="Postings tagged jrockit" style="font-size: 10.5px; line-height:10.5px">jrockit</a> <a href="/tags/jsf" title="Postings tagged jsf" style="font-size: 10.5px; line-height:10.5px">jsf</a> <a href="/tags/jta" title="Postings tagged jta" style="font-size: 10.5px; line-height:10.5px">jta</a> <a href="/tags/ldap" title="Postings tagged ldap" style="font-size: 10.5px; line-height:10.5px">ldap</a> <a href="/tags/lingo" title="Postings tagged lingo" style="font-size: 10.5px; line-height:10.5px">lingo</a> <a href="/tags/maven" title="Postings tagged maven" style="font-size: 13.0px; line-height:13.0px">maven</a> <a href="/tags/misc" title="Postings tagged misc" style="font-size: 13.0px; line-height:13.0px">misc</a> <a href="/tags/osgi" title="Postings tagged osgi" style="font-size: 10.5px; line-height:10.5px">osgi</a> <a href="/tags/quartz" title="Postings tagged quartz" style="font-size: 10.5px; line-height:10.5px">quartz</a> <a href="/tags/rails" title="Postings tagged rails" style="font-size: 10.5px; line-height:10.5px">rails</a> <a href="/tags/ruby" title="Postings tagged ruby" style="font-size: 10.5px; line-height:10.5px">ruby</a> <a href="/tags/seam" title="Postings tagged seam" style="font-size: 12.0px; line-height:12.0px">seam</a> <a href="/tags/security" title="Postings tagged security" style="font-size: 12.0px; line-height:12.0px">security</a> <a href="/tags/snmp" title="Postings tagged snmp" style="font-size: 10.5px; line-height:10.5px">snmp</a> <a href="/tags/spring" title="Postings tagged spring" style="font-size: 15.0px; line-height:15.0px">spring</a> <a href="/tags/subversion" title="Postings tagged subversion" style="font-size: 10.5px; line-height:10.5px">subversion</a> <a href="/tags/swing" title="Postings tagged swing" style="font-size: 10.5px; line-height:10.5px">swing</a> <a href="/tags/tomcat" title="Postings tagged tomcat" style="font-size: 11.0px; line-height:11.0px">tomcat</a> <a href="/tags/tuning" title="Postings tagged tuning" style="font-size: 10.5px; line-height:10.5px">tuning</a> <a href="/tags/voip" title="Postings tagged voip" style="font-size: 10.5px; line-height:10.5px">voip</a> <a href="/tags/vpn" title="Postings tagged vpn" style="font-size: 10.5px; line-height:10.5px">vpn</a> <a href="/tags/web2.0-ria" title="Postings tagged web2.0-ria" style="font-size: 10.5px; line-height:10.5px">web2.0-ria</a> <a href="/tags/weblogic" title="Postings tagged weblogic" style="font-size: 20.0px; line-height:20.0px">weblogic</a> <a href="/tags/webservices" title="Postings tagged webservices" style="font-size: 10.5px; line-height:10.5px">webservices</a> <a href="/tags/websphere" title="Postings tagged websphere" style="font-size: 10.5px; line-height:10.5px">websphere</a> <a href="/tags/xfire" title="Postings tagged xfire" style="font-size: 10.5px; line-height:10.5px">xfire</a> <a href="/tags/xpath" title="Postings tagged xpath" style="font-size: 10.5px; line-height:10.5px">xpath</a> </p></section>
<section>
  <h1>Visitors</h1>
  <p><a href="http://www2.clustrmaps.com/counter/maps.php?url=http://www.dewavrin.info" id="clustrMapsLink"><img src="http://www2.clustrmaps.com/counter/index2.php?url=http://www.dewavrin.info" style="text-decoration: none; margin-bottom: 1em; border:1px solid;" onmouseover="this.style.textDecoration = 'none'" alt="Locations of visitors to this page" title="Locations of visitors to this page" id="clustrMapsImg" onError="this.onError=null; this.src='http://clustrmaps.com/images/clustrmaps-back-soon.jpg'; document.getElementById('clustrMapsLink').href='http://clustrmaps.com'" /> </a>
</p>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Luc Dewavrin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'lucdewavrinsblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://lucdew.github.com/blog/memory-leaks-2/';
        var disqus_url = 'http://lucdew.github.com/blog/memory-leaks-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
